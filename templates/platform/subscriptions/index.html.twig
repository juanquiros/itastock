{% extends 'platform/base_platform.html.twig' %}

{% block header_title %}Suscripciones{% endblock %}

{% block body %}
    <form method="get" class="row g-2 align-items-end mb-3">
        <div class="col-md-4">
            <label class="form-label">Estado</label>
            <select class="form-select" name="status">
                <option value="">Todos</option>
                {% for s in ['TRIAL','ACTIVE','PAST_DUE','CANCELED','SUSPENDED','PENDING'] %}
                    <option value="{{ s }}" {{ filters.status == s ? 'selected' : '' }}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Plan</label>
            <select class="form-select" name="plan">
                <option value="">Todos</option>
                {% for plan in plans %}
                    <option value="{{ plan.id }}" {{ filters.plan == plan.id ? 'selected' : '' }}>{{ plan.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Requiere acción</label>
            <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" name="requires_action" value="1" id="requires_action" {{ filters.requires_action ? 'checked' : '' }}>
                <label class="form-check-label" for="requires_action">Sí</label>
            </div>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-outline-primary" type="submit">Filtrar</button>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>Comercio</th>
                    <th>Plan</th>
                    <th>Estado</th>
                    <th>Inicio</th>
                    <th>Trial hasta</th>
                    <th>Fin</th>
                    <th>Próximo cobro</th>
                    <th>READONLY efectivo</th>
                    <th>Override</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for subscription in subscriptions %}
                    {% set readonlyEffective = subscription.status in ['PAST_DUE', 'SUSPENDED', 'CANCELED']
                        or (subscription.status == 'TRIAL' and subscription.trialEndsAt and subscription.trialEndsAt <= now) %}
                    <tr>
                        <td><a href="{{ path('platform_business_show', {id: subscription.business.id}) }}">{{ subscription.business.name }}</a></td>
                        <td>{{ subscription.plan.name }}</td>
                        <td>{{ subscription.status }}</td>
                        <td>{{ subscription.startAt|date('Y-m-d') }}</td>
                        <td>{{ subscription.trialEndsAt ? subscription.trialEndsAt|date('Y-m-d') : '—' }}</td>
                        <td>{{ subscription.endAt ? subscription.endAt|date('Y-m-d') : '—' }}</td>
                        <td>{{ subscription.nextPaymentAt ? subscription.nextPaymentAt|date('Y-m-d') : '—' }}</td>
                        <td>{{ readonlyEffective ? 'Sí' : 'No' }}</td>
                        <td>
                            {% if subscription.overrideMode %}
                                {{ subscription.overrideMode }}{% if subscription.overrideUntil %} · {{ subscription.overrideUntil|date('Y-m-d') }}{% endif %}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="d-flex flex-column gap-2 align-items-end">
                                <form method="post" action="{{ path('platform_subscriptions_resync', {id: subscription.id}) }}" class="d-inline">
                                    <input type="hidden" name="_token" value="{{ csrf_token('platform_subscription_action_' ~ subscription.id) }}">
                                    <button class="btn btn-sm btn-outline-primary" type="submit">Resync</button>
                                </form>
                                <form method="post" action="{{ path('platform_subscriptions_override', {id: subscription.id}) }}" class="d-flex gap-2">
                                    <input type="hidden" name="_token" value="{{ csrf_token('platform_subscription_action_' ~ subscription.id) }}">
                                    <select class="form-select form-select-sm" name="override_mode">
                                        <option value="" {{ subscription.overrideMode is null ? 'selected' : '' }}>Sin override</option>
                                        {% for mode in ['FULL','READONLY','BLOCKED'] %}
                                            <option value="{{ mode }}" {{ subscription.overrideMode == mode ? 'selected' : '' }}>{{ mode }}</option>
                                        {% endfor %}
                                    </select>
                                    <input class="form-control form-control-sm" type="date" name="override_until" value="{{ subscription.overrideUntil ? subscription.overrideUntil|date('Y-m-d') : '' }}">
                                    <input class="form-control form-control-sm" type="number" name="grace_period_days" min="0" max="30" placeholder="Gracia" value="{{ subscription.gracePeriodDays }}">
                                    <button class="btn btn-sm btn-outline-secondary" type="submit">Guardar</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="10">Sin suscripciones.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
