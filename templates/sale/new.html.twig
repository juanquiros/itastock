{% extends 'base.html.twig' %}

{% block title %}Nueva venta - ItaStock{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .pos-new .pos-header {
            gap: 1rem;
        }

        .pos-new .sale-items-table {
            max-height: 360px;
            overflow-y: auto;
        }

        .pos-new .sale-items-table table {
            min-width: 520px;
        }

        .pos-new .pos-search-results {
            max-height: 360px;
            overflow-y: auto;
        }

        .pos-new-container {
            max-width: 100%;
        }

        @media (max-width: 991.98px) {
            .pos-new-container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            .pos-new .pos-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .pos-new .pos-header .btn {
                width: 100%;
            }

            .pos-new .card-body {
                padding: 1rem;
            }

            .pos-new .sale-items-table {
                max-height: 35vh;
            }

            .pos-new .pos-search-results {
                max-height: 40vh;
            }

            .pos-new .pos-summary-actions {
                flex-direction: column;
            }

            .pos-new .pos-summary-actions .btn {
                width: 100%;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <div class="row mb-4 pos-new">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-3 pos-header">
                <div>
                    <p class="text-uppercase text-muted mb-1 small">Venta rápida</p>
                    <h1 class="h3 mb-0">Nueva venta</h1>
                    <p class="mb-0 text-muted">Seleccioná cliente y armá el ticket con los artículos.</p>
                </div>
                <a class="btn btn-outline-secondary" href="{{ path('app_dashboard') }}">Volver</a>
            </div>

            <div class="card shadow-sm p-4 mb-4" id="customer-step">
                <form method="post" id="sale-form" data-controller="barcode-scanner" data-barcode-scanner-script-url-value="{{ asset('vendor/html5-qrcode.min.js') }}" data-barcode-scanner-continuous-value="true" {% if barcodeScanSoundPath %}data-barcode-scanner-success-sound-url-value="{{ barcodeScanSoundPath }}"{% endif %}>
                    <div class="mb-4">
                        <input type="hidden" name="customer_id" id="customer-id" value="">
                        <input type="hidden" name="payment_method" id="payment-method" value="CASH">
                        <input type="hidden" name="cash_given" id="cash-given-input" value="">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 border rounded-3 px-3 py-2 bg-light">
                            <div class="d-flex align-items-center gap-2" id="customer-selection"></div>
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="customer-edit">Modificar cliente</button>
                                <button type="button" class="btn btn-link btn-sm text-muted" id="customer-clear">Consumidor final</button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 d-none" id="customer-panel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-semibold mb-0" for="customer-search">Seleccionar cliente</label>
                            <button type="button" class="btn btn-link p-0" id="customer-cancel">Cerrar</button>
                        </div>
                        <input type="search" id="customer-search" class="form-control" placeholder="Nombre o documento" autocomplete="off">
                        <div class="form-text">Elegí un cliente activo o continuá como consumidor final.</div>
                        <div class="mt-3 list-group" id="customer-results"></div>
                    </div>

                    <div class="mt-4 d-none" id="sale-workspace">
                        <div class="row g-3">
                            <div class="col-lg-5">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold">Filtrar artículos</label>
                                            <div class="input-group" data-barcode-scanner-input-group>
                                                <input type="search" id="product-search" class="form-control form-control-lg" placeholder="Nombre, SKU o código de barras" data-barcode-scanner-target="input" data-barcode-scanner-input="true">
                                                <button class="btn btn-outline-secondary d-inline-flex d-lg-none" type="button" data-action="barcode-scanner#open" data-barcode-scanner-input-id-param="product-search">
                                                    Escanear
                                                </button>
                                            </div>
                                            <div id="barcode-scan-alert" class="alert alert-warning d-none mt-3" role="alert"></div>
                                            <div class="form-text">Escribí para filtrar y agregá con un clic.</div>
                                        </div>

                                        <div class="mb-0 pos-search-results" id="search-results"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-7">
                                <div class="card shadow-sm mb-3">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center justify-content-between mb-3">
                                            <h2 class="h5 mb-0">Detalle del ticket</h2>
                                            <span class="badge text-bg-dark">Stock se descuenta al confirmar</span>
                                        </div>
                                        <div class="table-responsive sale-items-table">
                                            <table class="table align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Producto</th>
                                                        <th class="text-end">Precio</th>
                                                        <th style="width: 140px;">Cantidad</th>
                                                        <th class="text-end">Total</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="sale-items">
                                                    <tr id="empty-row">
                                                        <td colspan="5" class="text-center text-muted py-4">Todavía no agregaste productos.</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="text-muted">Subtotal</div>
                                            <div class="fw-semibold" id="sale-subtotal">$0.00</div>
                                        </div>
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <div class="text-muted">Descuentos</div>
                                            <div class="fw-semibold text-danger" id="sale-discount-total">-$0.00</div>
                                        </div>
                                        <ul class="list-unstyled small text-muted mb-3" id="sale-discounts"></ul>
                                        <div class="d-flex align-items-center justify-content-between mb-3">
                                            <div class="text-muted">Total final</div>
                                            <div class="h3 mb-0 fw-bold" id="sale-total">$0.00</div>
                                        </div>
                                        <div class="d-flex justify-content-between gap-2 pos-summary-actions">
                                            <a class="btn btn-outline-secondary" href="{{ path('app_dashboard') }}">Cancelar</a>
                                            <button type="button" class="btn btn-primary btn-lg" id="confirm-sale" data-bs-toggle="modal" data-bs-target="#paymentModal">Continuar al pago</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% include 'shared/_barcode_scanner_modal.html.twig' %}
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailsModalLabel">Detalle de producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="fw-semibold mb-2" id="product-details-name">-</h6>
                    <div class="text-muted small mb-3" id="product-details-meta">-</div>
                    <div class="small mb-3" id="product-details-summary"></div>
                    <div>
                        <div class="fw-semibold mb-2">Características completas</div>
                        <div id="product-details-characteristics" class="small text-muted">Sin características.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Confirmar venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold" for="payment-method-modal">Medio de pago</label>
                        <select id="payment-method-modal" class="form-select form-select-lg">
                            <option value="CASH">Efectivo</option>
                            <option value="TRANSFER">Transferencia</option>
                            <option value="CARD">Tarjeta</option>
                            <option value="ACCOUNT">Cuenta corriente</option>
                        </select>
                        <div class="form-text" id="payment-help">Seleccioná un cliente para habilitar la cuenta corriente.</div>
                    </div>
                    <div class="mb-3 d-none" id="cash-section">
                        <label class="form-label fw-semibold" for="cash-given">Monto recibido</label>
                        <input type="number" id="cash-given" class="form-control" min="0" step="0.01" placeholder="0.00">
                        <div class="form-text">Cambio: <span class="fw-semibold" id="cash-change">$0.00</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Volver</button>
                    <button type="button" class="btn btn-primary" id="finalize-sale">Finalizar venta</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        const initializeSalePage = () => {
            const saleForm = document.getElementById('sale-form');
            if (!saleForm || saleForm.dataset.saleInitialized === 'true') {
                return;
            }

            const mainContainer = document.querySelector('main.container');
            if (mainContainer) {
                mainContainer.classList.add('pos-new-container');
            }

            saleForm.dataset.saleInitialized = 'true';
            let products = {{ productPayload|json_encode|raw }};
            let customers = {{ customersPayload|json_encode|raw }};
            let priceLists = {{ priceLists|json_encode|raw }};
            let priceListPrices = {{ priceListPrices|json_encode|raw }};
            let defaultPriceListId = {{ defaultPriceListId|json_encode|raw }};
            const items = [];
            let selectedCustomer = null;
            const snapshotUrl = '{{ path('app_sale_snapshot') }}';
            const productSearchUrl = '{{ path('app_products_search') }}';
            let snapshotInFlight = false;
            let snapshotTimer = null;

            const searchInput = document.getElementById('product-search');
            const resultsContainer = document.getElementById('search-results');
            const itemsTable = document.getElementById('sale-items');
            const emptyRow = document.getElementById('empty-row');
            const subtotalElement = document.getElementById('sale-subtotal');
            const discountTotalElement = document.getElementById('sale-discount-total');
            const discountList = document.getElementById('sale-discounts');
            const totalElement = document.getElementById('sale-total');
            const customerSearch = document.getElementById('customer-search');
            const customerResults = document.getElementById('customer-results');
            const customerSelection = document.getElementById('customer-selection');
            const customerField = document.getElementById('customer-id');
            const customerClear = document.getElementById('customer-clear');
            const customerEdit = document.getElementById('customer-edit');
            const customerPanel = document.getElementById('customer-panel');
            const customerCancel = document.getElementById('customer-cancel');
            const paymentMethod = document.getElementById('payment-method');
            const paymentMethodModal = document.getElementById('payment-method-modal');
            const paymentHelp = document.getElementById('payment-help');
            const cashSection = document.getElementById('cash-section');
            const cashGiven = document.getElementById('cash-given');
            const cashGivenInput = document.getElementById('cash-given-input');
            const cashChange = document.getElementById('cash-change');
            const customerStep = document.getElementById('customer-step');
            const saleWorkspace = document.getElementById('sale-workspace');
            const confirmSale = document.getElementById('confirm-sale');
            const finalizeSale = document.getElementById('finalize-sale');
            const scanAlert = document.getElementById('barcode-scan-alert');
            const scanWarningModal = document.getElementById('barcode-scan-warning');
            const productDetailsName = document.getElementById('product-details-name');
            const productDetailsMeta = document.getElementById('product-details-meta');
            const productDetailsSummary = document.getElementById('product-details-summary');
            const productDetailsCharacteristics = document.getElementById('product-details-characteristics');
            const previewUrl = '{{ path('app_sale_preview') }}';
            let currentSubtotal = 0;
            let currentDiscountTotal = 0;
            let currentTotal = 0;
            let previewTimer = null;
            let previewInFlight = false;

            function formatMoney(value) {
                return `$${value.toFixed(2)}`;
            }

            function resolvePriceListId() {
                if (selectedCustomer && selectedCustomer.priceList) {
                    const candidate = priceLists.find((pl) => pl.id === selectedCustomer.priceList && pl.isDefault === false) || priceLists.find((pl) => pl.id === selectedCustomer.priceList);
                    if (candidate) {
                        return candidate.id;
                    }
                }

                return defaultPriceListId;
            }

            function resolveUnitPrice(productId) {
                const listId = resolvePriceListId();
                if (listId && priceListPrices[listId] && priceListPrices[listId][productId] !== undefined) {
                    return parseFloat(priceListPrices[listId][productId]);
                }

                const product = products.find((p) => p.id === productId);
                return product ? parseFloat(product.price) : 0;
            }

            function resolveQtyStep(product) {
                if (product.qtyStep !== null && product.qtyStep !== undefined) {
                    return parseFloat(product.qtyStep);
                }

                return product.uomBase !== 'UNIT' ? 0.001 : 1;
            }

            function showScanAlert(message) {
                const targets = [scanAlert, scanWarningModal];

                targets.forEach((target) => {
                    if (!target) {
                        return;
                    }

                    if (!message) {
                        target.textContent = '';
                        target.classList.add('d-none');
                        return;
                    }

                    target.textContent = message;
                    target.classList.remove('d-none');
                });
            }

            function normalizeQty(value, item) {
                const step = item.allowsFractional ? item.qtyStep : 1;
                const min = item.allowsFractional ? item.qtyStep : 1;
                const numeric = Number.isFinite(value) ? value : min;

                const scaledStep = Math.max(1, Math.round(step * 1000));
                const scaledValue = Math.max(min * 1000, Math.round(numeric * 1000));
                const snapped = Math.round(scaledValue / scaledStep) * scaledStep;
                const limited = Math.min(snapped, Math.round(item.stock * 1000));

                return limited / 1000;
            }

            function renderCustomerSelection() {
                if (!selectedCustomer) {
                    customerSelection.innerHTML = `
                        <span class="fw-semibold">Consumidor final</span>
                        <span class="text-muted small">Sin cliente asignado</span>
                    `;
                    customerField.value = '';
                    updateAccountOption();
                    syncPaymentMethod();
                    return;
                }

                const statusBadge = selectedCustomer.isActive
                    ? ''
                    : '<span class="badge text-bg-warning text-uppercase">Inactivo</span>';

                customerSelection.innerHTML = `
                    <div>
                        <div class="fw-semibold">${selectedCustomer.name}</div>
                        <div class="text-muted small">${selectedCustomer.document ? selectedCustomer.document : 'Sin documento'}</div>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge text-bg-primary text-uppercase">${selectedCustomer.type.replace('_', ' ')}</span>
                        ${statusBadge}
                    </div>
                `;
                customerField.value = selectedCustomer.id;
                updateAccountOption();
                syncPaymentMethod();
            }

            function renderCustomerResults(term = '') {
                const value = term.trim().toLowerCase();
                if (value === '') {
                    customerResults.innerHTML = '';
                    return;
                }

                const filtered = customers.filter((c) => c.name.toLowerCase().includes(value) || (c.document && c.document.toLowerCase().includes(value))).slice(0, 5);

                if (filtered.length === 0) {
                    customerResults.innerHTML = '<div class="text-muted small">Sin coincidencias.</div>';
                    return;
                }

                customerResults.innerHTML = filtered.map((customer) => `
                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-customer="${customer.id}">
                        <div>
                            <div class="fw-semibold">${customer.name}</div>
                            <div class="text-muted small">${customer.document ? customer.document : 'Sin documento'}</div>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge text-bg-light text-uppercase">${customer.type.replace('_', ' ')}</span>
                            ${customer.isActive ? '' : '<span class="badge text-bg-warning text-uppercase">Inactivo</span>'}
                        </div>
                    </button>
                `).join('');

                customerResults.querySelectorAll('button[data-customer]').forEach((button) => {
                    button.addEventListener('click', () => {
                        const id = parseInt(button.dataset.customer, 10);
                        selectedCustomer = customers.find((c) => c.id === id) || null;
                        renderCustomerSelection();
                        recalculatePrices();
                        customerResults.innerHTML = '';
                        customerSearch.value = '';
                    });
                });
            }

            function findExactProduct(term) {
                const normalized = term.trim().toLowerCase();
                if (normalized === '') {
                    return null;
                }

                return products.find((product) => (
                    (product.barcode && product.barcode.toLowerCase() === normalized)
                    || (product.sku && product.sku.toLowerCase() === normalized)
                )) || null;
            }

            function mergeProducts(incoming) {
                incoming.forEach((candidate) => {
                    const existing = products.find((item) => item.id === candidate.id);
                    if (existing) {
                        Object.assign(existing, {
                            name: candidate.name,
                            barcode: candidate.barcode,
                            sku: candidate.sku,
                            price: candidate.precio,
                            stock: candidate.stock,
                            uomBase: candidate.uomBase,
                            allowsFractionalQty: candidate.allowsFractionalQty,
                            qtyStep: candidate.qtyStep,
                            characteristicsSummary: candidate.characteristicsSummary || null,
                            characteristics: candidate.characteristics || {},
                            brand: candidate.brand || null,
                            category: candidate.category || null,
                        });

                        return;
                    }

                    products.push({
                        id: candidate.id,
                        name: candidate.name,
                        barcode: candidate.barcode,
                        sku: candidate.sku,
                        price: candidate.precio,
                        stock: candidate.stock,
                        uomBase: candidate.uomBase,
                        allowsFractionalQty: candidate.allowsFractionalQty,
                        qtyStep: candidate.qtyStep,
                        characteristicsSummary: candidate.characteristicsSummary || null,
                        characteristics: candidate.characteristics || {},
                        brand: candidate.brand || null,
                        category: candidate.category || null,
                    });
                });
            }


            function escapeHtml(value) {
                return String(value ?? '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            function openProductDetails(productId) {
                const product = products.find((item) => item.id === productId);
                if (!product) {
                    return;
                }

                productDetailsName.textContent = product.name || '-';
                productDetailsMeta.textContent = `SKU: ${product.sku || '-'}${product.barcode ? ` · Código: ${product.barcode}` : ''}${product.brand ? ` · Marca: ${product.brand}` : ''}${product.category ? ` · Categoría: ${product.category}` : ''}`;
                productDetailsSummary.textContent = product.characteristicsSummary || 'Sin resumen de características.';

                const entries = Object.entries(product.characteristics || {});
                if (entries.length === 0) {
                    productDetailsCharacteristics.textContent = 'Sin características.';
                    return;
                }

                productDetailsCharacteristics.innerHTML = `<ul class="mb-0 ps-3">${entries.map(([key, value]) => `<li><strong>${escapeHtml(key)}:</strong> ${escapeHtml(value)}</li>`).join('')}</ul>`;
            }

            let currentSearchResults = [];
            let searchController = null;

            async function renderResults(query = '') {
                const term = query.trim();
                if (term === '') {
                    currentSearchResults = [];
                    resultsContainer.innerHTML = '';
                    return [];
                }

                const exactMatch = findExactProduct(term);
                if (exactMatch) {
                    currentSearchResults = [exactMatch];
                    resultsContainer.innerHTML = '';
                    return currentSearchResults;
                }

                if (searchController) {
                    searchController.abort();
                }
                searchController = new AbortController();

                try {
                    const response = await fetch(`${productSearchUrl}?q=${encodeURIComponent(term)}&limit=50`, {
                        headers: { Accept: 'application/json' },
                        signal: searchController.signal,
                    });
                    if (!response.ok) {
                        return [];
                    }

                    const filtered = await response.json();
                    mergeProducts(filtered);
                    currentSearchResults = filtered.map((item) => products.find((product) => product.id === item.id)).filter(Boolean).slice(0, 6);

                    if (currentSearchResults.length === 0) {
                        resultsContainer.innerHTML = '';
                        return [];
                    }

                    const list = currentSearchResults.map((product) => `
                        <div class="d-flex align-items-center justify-content-between border rounded-3 p-3 mb-2 bg-white">
                            <div>
                                <div class="fw-semibold">${product.name}</div>
                                ${product.characteristicsSummary ? `<div class="text-muted small">${product.characteristicsSummary}</div>` : ''}
                                <div class="text-muted small">SKU: ${product.sku}${product.barcode ? ' · Código: ' + product.barcode : ''}</div>
                                <div class="text-muted small">Stock disponible: ${product.stock} ${product.uomBase}</div>
                                ${product.characteristicsSummary ? `<button type="button" class="btn btn-link btn-sm p-0 mt-1" data-product-details="${product.id}" data-bs-toggle="modal" data-bs-target="#productDetailsModal">Ver más</button>` : ''}
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span class="fw-semibold">${formatMoney(resolveUnitPrice(product.id))}</span>
                                <button type="button" class="btn btn-sm btn-primary" data-product="${product.id}">Agregar</button>
                            </div>
                        </div>
                    `).join('');

                    resultsContainer.innerHTML = list;
                    resultsContainer.querySelectorAll('button[data-product]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            addItem(parseInt(btn.dataset.product, 10));
                            searchInput.value = '';
                            renderResults('');
                            searchInput.focus();
                        });
                    });

                    resultsContainer.querySelectorAll('button[data-product-details]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            openProductDetails(parseInt(btn.dataset.productDetails, 10));
                        });
                    });

                    return currentSearchResults;
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.warn('Error buscando productos', error);
                    }

                    return [];
                }
            }

            function addItem(productId) {
                const product = products.find((p) => p.id === productId);
                if (!product) {
                    return;
                }

                const step = resolveQtyStep(product);
                const minQty = product.allowsFractionalQty ? step : 1;
                const defaultQty = minQty;
                const existing = items.find((item) => item.product_id === productId);
                if (existing) {
                    existing.qty = normalizeQty(existing.qty + defaultQty, existing);
                } else {
                    const newItem = {
                        product_id: product.id,
                        name: product.name,
                        characteristicsSummary: product.characteristicsSummary || null,
                        price: resolveUnitPrice(product.id),
                        stock: product.stock,
                        qty: defaultQty,
                        qtyStep: step,
                        allowsFractional: product.allowsFractionalQty === true,
                        uomBase: product.uomBase,
                    };
                    const normalizedQty = normalizeQty(newItem.qty, newItem);
                    if (normalizedQty < minQty) {
                        return;
                    }
                    newItem.qty = normalizedQty;
                    items.push(newItem);
                }

                renderItems();
            }

            function recalculatePrices() {
                items.forEach((item) => {
                    item.price = resolveUnitPrice(item.product_id);
                });
                renderItems();
            }

            function renderItems() {
                itemsTable.innerHTML = '';

                if (items.length === 0) {
                    itemsTable.appendChild(emptyRow);
                    emptyRow.style.display = '';
                    updateTotal();
                    confirmSale.disabled = true;
                    return;
                }

                emptyRow.style.display = 'none';
                confirmSale.disabled = false;

                items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const min = item.allowsFractional ? item.qtyStep : 1;
                    const step = item.allowsFractional ? item.qtyStep : 1;
                    row.innerHTML = `
                        <td>
                            <div class="fw-semibold">${item.name}</div>
                            ${item.characteristicsSummary ? `<div class="text-muted small">${item.characteristicsSummary}</div>` : ''}
                            <input type="hidden" name="items[${index}][product_id]" value="${item.product_id}">
                        </td>
                        <td class="text-end">${formatMoney(item.price)}</td>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="number" min="${min}" max="${item.stock}" step="${step}" name="items[${index}][qty]" value="${item.qty.toFixed(3)}" class="form-control form-control-sm" data-index="${index}">
                                <span class="input-group-text">${item.uomBase}</span>
                            </div>
                        </td>
                        <td class="text-end">${formatMoney(item.price * item.qty)}</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-link text-danger" data-remove="${index}">Eliminar</button>
                        </td>
                    `;
                    itemsTable.appendChild(row);
                });

                itemsTable.querySelectorAll('input[type="number"]').forEach((input) => {
                    input.addEventListener('change', (event) => {
                        const idx = parseInt(event.target.dataset.index, 10);
                        const value = parseFloat(event.target.value);
                        items[idx].qty = normalizeQty(value, items[idx]);
                        renderItems();
                    });
                });

                itemsTable.querySelectorAll('button[data-remove]').forEach((button) => {
                    button.addEventListener('click', (event) => {
                        const idx = parseInt(event.target.dataset.remove, 10);
                        items.splice(idx, 1);
                        renderItems();
                    });
                });

                updateTotal();
            }

            function renderDiscountList(discounts = []) {
                if (!discountList) {
                    return;
                }

                if (!discounts || discounts.length === 0) {
                    discountList.innerHTML = '<li>Sin descuentos aplicados.</li>';
                    return;
                }

                discountList.innerHTML = discounts.map((discount) => {
                    const amount = discount.appliedAmount ? parseFloat(discount.appliedAmount) : 0;
                    return `<li>${discount.name} · -${formatMoney(amount)}</li>`;
                }).join('');
            }

            function applyFallbackTotals() {
                currentSubtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                currentDiscountTotal = 0;
                currentTotal = currentSubtotal;

                if (subtotalElement) {
                    subtotalElement.textContent = formatMoney(currentSubtotal);
                }
                if (discountTotalElement) {
                    discountTotalElement.textContent = `-${formatMoney(currentDiscountTotal)}`;
                }
                totalElement.textContent = formatMoney(currentTotal);
                renderDiscountList([]);
                updateCashChange();
            }

            function applyPreviewTotals(payload) {
                if (!payload) {
                    return;
                }

                currentSubtotal = parseFloat(payload.subtotal || '0');
                currentDiscountTotal = parseFloat(payload.discountTotal || '0');
                currentTotal = parseFloat(payload.total || '0');

                if (subtotalElement) {
                    subtotalElement.textContent = formatMoney(currentSubtotal);
                }
                if (discountTotalElement) {
                    discountTotalElement.textContent = `-${formatMoney(currentDiscountTotal)}`;
                }
                totalElement.textContent = formatMoney(currentTotal);
                renderDiscountList(payload.discounts || []);
                updateCashChange();
            }

            function schedulePreview() {
                if (previewTimer) {
                    clearTimeout(previewTimer);
                }
                previewTimer = setTimeout(() => {
                    fetchPreview();
                }, 350);
            }

            async function fetchPreview() {
                if (previewInFlight || items.length === 0) {
                    return;
                }

                previewInFlight = true;
                try {
                    const response = await fetch(previewUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
                        body: JSON.stringify({
                            items: items.map((item) => ({
                                product_id: item.product_id,
                                qty: item.qty.toFixed(3),
                            })),
                            customer_id: selectedCustomer ? selectedCustomer.id : 0,
                            payment_method: paymentMethodModal.value,
                        }),
                    });

                    if (!response.ok) {
                        applyFallbackTotals();
                        return;
                    }

                    const payload = await response.json();
                    applyPreviewTotals(payload);
                } catch (error) {
                    console.warn('No se pudo previsualizar el descuento', error);
                    applyFallbackTotals();
                } finally {
                    previewInFlight = false;
                }
            }

            function updateTotal() {
                applyFallbackTotals();
                schedulePreview();
            }

            function updateCashChange() {
                if (!cashSection || cashSection.classList.contains('d-none')) {
                    return;
                }

                const given = parseFloat(cashGiven.value || '0');
                const change = given - currentTotal;
                cashChange.textContent = formatMoney(Math.max(change, 0));
            }

            function canUseAccount() {
                return selectedCustomer && selectedCustomer.isActive;
            }

            function updateAccountOption() {
                const accountOption = paymentMethodModal.querySelector('option[value="ACCOUNT"]');
                const allowAccount = canUseAccount();
                accountOption.disabled = !allowAccount;

                if (!selectedCustomer) {
                    paymentHelp.textContent = 'Seleccioná un cliente para habilitar la cuenta corriente.';
                } else if (!selectedCustomer.isActive) {
                    paymentHelp.textContent = 'Cuenta corriente no disponible. Comuníquese con el administrador.';
                } else {
                    paymentHelp.textContent = 'Usá cuenta corriente solo con clientes activos.';
                }

                if (!allowAccount && paymentMethodModal.value === 'ACCOUNT') {
                    paymentMethodModal.value = 'CASH';
                }
            }

            function syncPaymentMethod() {
                if (paymentMethodModal.value === 'ACCOUNT' && !canUseAccount()) {
                    paymentMethodModal.value = 'CASH';
                }
                paymentMethod.value = paymentMethodModal.value;
                if (paymentMethodModal.value === 'CASH') {
                    cashSection.classList.remove('d-none');
                    updateCashChange();
                } else {
                    cashSection.classList.add('d-none');
                    cashGiven.value = '';
                    cashGivenInput.value = '';
                }
                updateTotal();
            }

            function showWorkspace() {
                saleWorkspace.classList.remove('d-none');
                confirmSale.disabled = items.length === 0;
                saleWorkspace.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function applySnapshot(snapshot) {
                if (!snapshot || !snapshot.products || !snapshot.customers) {
                    return;
                }

                products = snapshot.products;
                customers = snapshot.customers;
                priceLists = snapshot.priceLists || [];
                priceListPrices = snapshot.priceListPrices || {};
                defaultPriceListId = snapshot.defaultPriceListId;

                if (selectedCustomer) {
                    selectedCustomer = customers.find((customer) => customer.id === selectedCustomer.id) || null;
                }

                const productIndex = new Map(products.map((product) => [product.id, product]));
                const removedItems = [];

                for (let i = items.length - 1; i >= 0; i--) {
                    const item = items[i];
                    const product = productIndex.get(item.product_id);
                    if (!product) {
                        removedItems.push(item);
                        items.splice(i, 1);
                        continue;
                    }

                    item.name = product.name;
                    item.characteristicsSummary = product.characteristicsSummary || null;
                    item.stock = product.stock;
                    item.uomBase = product.uomBase;
                    item.qtyStep = resolveQtyStep(product);
                    item.allowsFractional = product.allowsFractionalQty === true;
                    item.price = resolveUnitPrice(product.id);
                    item.qty = normalizeQty(item.qty, item);
                }

                if (removedItems.length > 0) {
                    showScanAlert('Se removieron productos que ya no están disponibles.');
                }

                renderCustomerSelection();
                renderItems();
                renderResults(searchInput.value);
                renderCustomerResults(customerSearch.value);
            }

            async function fetchSnapshot() {
                if (snapshotInFlight) {
                    return;
                }

                snapshotInFlight = true;
                try {
                    const response = await fetch(snapshotUrl, { headers: { Accept: 'application/json' } });
                    if (!response.ok) {
                        return;
                    }
                    const snapshot = await response.json();
                    applySnapshot(snapshot);
                } catch (error) {
                    console.warn('No se pudo sincronizar la venta', error);
                } finally {
                    snapshotInFlight = false;
                }
            }

            customerSearch.addEventListener('input', (event) => {
                renderCustomerResults(event.target.value);
            });

            customerSearch.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const value = customerSearch.value.trim().toLowerCase();
                    const filtered = customers.filter((c) => c.name.toLowerCase().includes(value) || (c.document && c.document.toLowerCase().includes(value)));
                    if (filtered.length > 0) {
                        selectedCustomer = filtered[0];
                        renderCustomerSelection();
                        recalculatePrices();
                        customerResults.innerHTML = '';
                        customerSearch.value = '';
                    }
                }
            });

            customerClear.addEventListener('click', () => {
                selectedCustomer = null;
                customerSearch.value = '';
                customerResults.innerHTML = '';
                renderCustomerSelection();
                recalculatePrices();
                customerPanel.classList.add('d-none');
                showWorkspace();
            });

            customerEdit.addEventListener('click', () => {
                customerPanel.classList.toggle('d-none');
                if (!customerPanel.classList.contains('d-none')) {
                    customerSearch.focus();
                }
            });

            customerCancel.addEventListener('click', () => {
                customerPanel.classList.add('d-none');
            });

            searchInput.addEventListener('input', (event) => {
                showScanAlert('');
                renderResults(event.target.value);
            });

            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const filtered = currentSearchResults;
                    if (filtered.length > 0) {
                        addItem(filtered[0].id);
                        searchInput.select();
                    }
                }
            });

            searchInput.addEventListener('barcode-scanner:scan', (event) => {
                const code = (event.detail?.code || '').trim();
                if (!code) {
                    return;
                }

                const match = findExactProduct(code);
                if (match) {
                    addItem(match.id);
                    showScanAlert('');
                    searchInput.value = '';
                    renderResults('');
                    return;
                }

                renderResults(code).then((filtered) => {
                    if (filtered.length > 0) {
                        addItem(filtered[0].id);
                        showScanAlert('');
                    } else {
                        showScanAlert(`No se encontró coincidencia para el código "${code}".`);
                    }
                    searchInput.value = '';
                    renderResults('');
                });
            });

            saleForm.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !(event.target instanceof HTMLButtonElement && event.target.type === 'submit')) {
                    event.preventDefault();
                }
            });

            saleForm.addEventListener('submit', () => {
                items.forEach((item, index) => {
                    const qtyInput = document.createElement('input');
                    qtyInput.type = 'hidden';
                    qtyInput.name = `items[${index}][qty]`;
                    qtyInput.value = item.qty.toFixed(3);
                    const productInput = document.createElement('input');
                    productInput.type = 'hidden';
                    productInput.name = `items[${index}][product_id]`;
                    productInput.value = item.product_id;
                    saleForm.appendChild(qtyInput);
                    saleForm.appendChild(productInput);
                });
            });

            paymentMethodModal.addEventListener('change', syncPaymentMethod);
            cashGiven.addEventListener('input', () => {
                cashGivenInput.value = cashGiven.value;
                updateCashChange();
            });

            finalizeSale.addEventListener('click', () => {
                syncPaymentMethod();
                if (paymentMethodModal.value === 'CASH') {
                    cashGivenInput.value = cashGiven.value;
                }
                saleForm.submit();
            });

            renderCustomerSelection();
            renderResults('');
            syncPaymentMethod();
            showWorkspace();

            fetchSnapshot();
            snapshotTimer = setInterval(fetchSnapshot, 20000);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    fetchSnapshot();
                }
            });
        };

        document.addEventListener('DOMContentLoaded', initializeSalePage);
        document.addEventListener('turbo:load', initializeSalePage);
    </script>
{% endblock %}
