<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; color: #222; }
        h1 { font-size: 18px; margin-bottom: 4px; }
        h2 { font-size: 14px; margin: 12px 0 6px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
        th, td { border: 1px solid #ddd; padding: 6px; }
        th { background: #f5f5f5; text-align: left; }
        .meta { margin-bottom: 12px; }
        .meta div { margin-bottom: 4px; }
        .totals { margin-top: 8px; text-align: right; }
        .legend { margin-top: 16px; font-size: 11px; color: #555; }
    </style>
</head>
<body>
    <h1>Factura {{ invoice.cbteTipo == 'FACTURA_B' ? 'B' : 'C' }}</h1>

    <div class="meta">
        {% if business.ticketHeaderImagePath %}
            <div style="margin-bottom: 8px;">
                <img src="{{ business.ticketHeaderImagePath }}" alt="Icono del comercio" style="max-height: 120px; max-width: 100%;">
            </div>
        {% endif %}
        <div><strong>Comercio:</strong> {{ business.name }}</div>
        {% set headerLines = business.ticketHeaderLines ? business.ticketHeaderLines|replace({'\r': ''})|split('\n') : [] %}
        {% if headerLines %}
            <div style="margin-top: 6px;">
                {% for line in headerLines %}
                    {% if line|trim %}
                        <div>{{ line }}</div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
        <div><strong>CUIT:</strong> {{ business.arcaConfig ? business.arcaConfig.cuitEmisor : '-' }}</div>
        <div><strong>Punto de venta:</strong> {{ invoice.arcaPosNumber }}</div>
        <div><strong>N° comprobante:</strong> {{ invoice.cbteNumero ?: '-' }}</div>
        <div><strong>CAE:</strong> {{ invoice.cae ?: '-' }}</div>
        <div><strong>Vto CAE:</strong> {{ invoice.caeDueDate ? invoice.caeDueDate|date('d/m/Y') : '-' }}</div>
        <div><strong>Fecha emisión:</strong> {{ invoice.issuedAt ? invoice.issuedAt|date('d/m/Y H:i') : sale.createdAt|date('d/m/Y H:i') }}</div>
        <div><strong>Cliente:</strong> {{ sale.customer ? sale.customer.name : 'Consumidor Final' }}</div>
        {% if sale.customer %}
            {% if sale.customer.documentType or sale.customer.documentNumber %}
                <div><strong>{{ sale.customer.documentType ?: 'Documento' }}:</strong> {{ sale.customer.documentNumber ?: '-' }}</div>
            {% endif %}
            {% if sale.customer.phone %}
                <div><strong>Teléfono:</strong> {{ sale.customer.phone }}</div>
            {% endif %}
            {% if sale.customer.address %}
                <div><strong>Dirección:</strong> {{ sale.customer.address }}</div>
            {% endif %}
        {% endif %}
    </div>

    <h2>Detalle de ítems</h2>
    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th style="text-align: right;">Cant.</th>
                <th style="text-align: right;">Precio</th>
                <th style="text-align: right;">IVA</th>
                <th style="text-align: right;">Total</th>
            </tr>
        </thead>
        <tbody>
        {% set items = invoice.itemsSnapshot ?: [] %}
        {% if items %}
            {% for item in items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td style="text-align: right;">{{ item.qty }}</td>
                    <td style="text-align: right;">${{ item.unitPrice }}</td>
                    <td style="text-align: right;">{{ item.ivaRate }}%</td>
                    <td style="text-align: right;">${{ item.lineTotal }}</td>
                </tr>
            {% endfor %}
        {% else %}
            {% for item in sale.items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td style="text-align: right;">{{ item.qty|number_format(3, '.', ',') }}</td>
                    <td style="text-align: right;">${{ item.unitPrice }}</td>
                    <td style="text-align: right;">-</td>
                    <td style="text-align: right;">${{ item.lineTotal }}</td>
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>

    <div class="totals">
        <div><strong>Neto:</strong> ${{ invoice.netAmount }}</div>
        <div><strong>IVA:</strong> ${{ invoice.vatAmount }}</div>
        <div><strong>Total:</strong> ${{ invoice.totalAmount }}</div>
    </div>

    <div style="margin-top:16px;">
        <div><strong>QR ARCA</strong></div>
        {% if qrDataUri is defined and qrDataUri %}
            <img src="{{ qrDataUri }}" alt="QR ARCA" style="width:140px;height:140px;">
            {% if qrUrl is defined and qrUrl %}
                <div style="font-size: 10px; color: #666; margin-top: 4px; word-break: break-all;">{{ qrUrl }}</div>
            {% endif %}
        {% else %}
            <div style="font-size: 11px; color: #777;">QR no disponible</div>
        {% endif %}
    </div>

    {% set footerLines = business.ticketFooterLines ? business.ticketFooterLines|replace({'\r': ''})|split('\n') : [] %}
    {% if footerLines %}
        <div style="margin-top: 8px;">
            {% for line in footerLines %}
                {% if line|trim %}
                    <div>{{ line }}</div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    {% if business.ticketFooterImagePath %}
        <div style="margin-top: 8px;">
            <img src="{{ business.ticketFooterImagePath }}" alt="Imagen final del ticket" style="max-height: 160px; max-width: 100%;">
        </div>
    {% endif %}

    <div class="legend">
        Comprobante emitido electrónicamente mediante ARCA. Generado en ItaStock el {{ generatedAt|date('d/m/Y H:i') }}.
    </div>
</body>
</html>
