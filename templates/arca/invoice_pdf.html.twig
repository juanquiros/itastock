<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; color: #222; }
        h1 { margin: 0; }
        h2 { font-size: 14px; margin: 14px 0 6px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
        th, td { border: 1px solid #ddd; padding: 6px; }
        th { background: #f5f5f5; text-align: left; }
        .doc-title { text-align: center; border: 1px solid #222; padding: 8px; margin-bottom: 10px; }
        .doc-title .type { font-size: 20px; font-weight: bold; }
        .doc-title .number { font-size: 14px; margin-top: 4px; }
        .head-two { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
        .head-two td { width: 50%; vertical-align: top; border: 1px solid #222; padding: 8px; }
        .head-label { font-weight: bold; margin-bottom: 6px; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
        .meta div { margin-bottom: 4px; }
        .totals { margin-top: 8px; text-align: right; }
        .legend { margin-top: 16px; font-size: 11px; color: #555; text-align: center; }
        .text-center { text-align: center; }
    </style>
</head>
<body>
    {% set headerLines = business.ticketHeaderLines ? business.ticketHeaderLines|replace({'\r': ''})|split('\n') : [] %}

    <div class="doc-title">
        <div class="type">FACTURA {{ invoice.cbteTipo == 'FACTURA_B' ? 'B' : 'C' }}</div>
        <div class="number">N° {{ '%04d'|format(invoice.arcaPosNumber) }}-{{ invoice.cbteNumero ? '%08d'|format(invoice.cbteNumero) : '--------' }}</div>
    </div>

    <table class="head-two">
        <tr>
            <td>
                <div class="head-label">Datos del sistema</div>
                <div class="meta">
                    <div><strong>Comercio:</strong> {{ business.name }}</div>
                    <div><strong>CUIT:</strong> {{ business.arcaConfig ? business.arcaConfig.cuitEmisor : '-' }}</div>
                    <div><strong>Punto de venta:</strong> {{ invoice.arcaPosNumber }}</div>
                    <div><strong>N° comprobante:</strong> {{ invoice.cbteNumero ?: '-' }}</div>
                    <div><strong>CAE:</strong> {{ invoice.cae ?: '-' }}</div>
                    <div><strong>Vto CAE:</strong> {{ invoice.caeDueDate ? invoice.caeDueDate|date('d/m/Y') : '-' }}</div>
                    <div><strong>Fecha emisión:</strong> {{ invoice.issuedAt ? invoice.issuedAt|date('d/m/Y H:i') : sale.createdAt|date('d/m/Y H:i') }}</div>
                    <div><strong>Cliente:</strong> {{ sale.customer ? sale.customer.name : 'Consumidor Final' }}</div>
                    {% if sale.customer %}
                        {% if sale.customer.documentType or sale.customer.documentNumber %}
                            <div><strong>{{ sale.customer.documentType ?: 'Documento' }}:</strong> {{ sale.customer.documentNumber ?: '-' }}</div>
                        {% endif %}
                        {% if sale.customer.phone %}
                            <div><strong>Teléfono:</strong> {{ sale.customer.phone }}</div>
                        {% endif %}
                        {% if sale.customer.address %}
                            <div><strong>Dirección:</strong> {{ sale.customer.address }}</div>
                        {% endif %}
                    {% endif %}
                </div>
            </td>
            <td>
                <div class="head-label">Datos configurados por el comercio</div>
                <div class="text-center">
                    {% if business.ticketHeaderImagePath %}
                        <div style="margin-bottom: 8px;">
                            <img src="{{ business.ticketHeaderImagePath }}" alt="Icono del comercio" style="max-height: 120px; max-width: 100%; margin: 0 auto; display: block;">
                        </div>
                    {% endif %}
                    {% if headerLines %}
                        <div style="margin-top: 6px; text-align: left; display: inline-block;">
                            {% for line in headerLines %}
                                {% if line|trim %}
                                    <div>{{ line }}</div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="meta" style="color: #777;">Sin datos adicionales de encabezado.</div>
                    {% endif %}
                </div>
            </td>
        </tr>
    </table>

    <h2>Detalle de ítems</h2>
    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th style="text-align: right;">Cant.</th>
                <th style="text-align: right;">Precio</th>
                <th style="text-align: right;">IVA</th>
                <th style="text-align: right;">Total</th>
            </tr>
        </thead>
        <tbody>
        {% set items = invoice.itemsSnapshot ?: [] %}
        {% if items %}
            {% for item in items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td style="text-align: right;">{{ item.qty }}</td>
                    <td style="text-align: right;">${{ item.unitPrice }}</td>
                    <td style="text-align: right;">{{ item.ivaRate }}%</td>
                    <td style="text-align: right;">${{ item.lineTotal }}</td>
                </tr>
            {% endfor %}
        {% else %}
            {% for item in sale.items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td style="text-align: right;">{{ item.qty|number_format(3, '.', ',') }}</td>
                    <td style="text-align: right;">${{ item.unitPrice }}</td>
                    <td style="text-align: right;">-</td>
                    <td style="text-align: right;">${{ item.lineTotal }}</td>
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>

    <div class="totals">
        <div><strong>Neto:</strong> ${{ invoice.netAmount }}</div>
        <div><strong>IVA:</strong> ${{ invoice.vatAmount }}</div>
        <div><strong>Total:</strong> ${{ invoice.totalAmount }}</div>
    </div>

    <div style="margin-top:16px;" class="text-center">
        <div><strong>QR ARCA</strong></div>
        {% if qrDataUri is defined and qrDataUri %}
            <img src="{{ qrDataUri }}" alt="QR ARCA" style="width:160px;height:160px; margin: 0 auto; display:block;">
            {% if qrUrl is defined and qrUrl %}
                <div style="font-size: 10px; color: #666; margin-top: 4px; word-break: break-all;">{{ qrUrl }}</div>
            {% endif %}
        {% else %}
            <div style="font-size: 11px; color: #777;">QR no disponible</div>
        {% endif %}
    </div>

    {% set footerLines = business.ticketFooterLines ? business.ticketFooterLines|replace({'\r': ''})|split('\n') : [] %}
    {% if footerLines %}
        <div style="margin-top: 8px;" class="text-center">
            {% for line in footerLines %}
                {% if line|trim %}
                    <div>{{ line }}</div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    {% if business.ticketFooterImagePath %}
        <div style="margin-top: 8px;" class="text-center">
            <img src="{{ business.ticketFooterImagePath }}" alt="Imagen final del ticket" style="max-height: 160px; max-width: 100%; margin:0 auto; display:block;">
        </div>
    {% endif %}

    <div class="legend">
        Comprobante emitido electrónicamente mediante ARCA. Generado en ItaStock el {{ generatedAt|date('d/m/Y H:i') }}.
    </div>
</body>
</html>
